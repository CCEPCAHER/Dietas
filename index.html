<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Maika Porcuna - Plan de Alimentaci√≥n Personalizada</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplicaci√≥n profesional para la creaci√≥n de planes de alimentaci√≥n personalizados - Nutrici√≥n, Diet√©tica, Suplementaci√≥n y Nutrici√≥n Deportiva">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MAIKA PORCUNA">
    <meta name="mobile-web-app-capable" content="yes">
    
          <!-- Manifest y Iconos -->
      <link rel="manifest" href="manifest.json?v=5">
    
    <!-- Favicon e iconos Apple -->
    <link rel="shortcut icon" href="icon-192x192.png?v=4">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png?v=4">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png?v=4">
    <link rel="apple-touch-icon" href="icon-180x180.png?v=4">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png?v=4">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png?v=4">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152x152.png?v=4">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png?v=4">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png?v=4">
    
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Librer√≠as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Librer√≠as para generar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <!-- Bot√≥n de modo oscuro -->
    <button id="darkModeToggle" class="dark-mode-toggle" title="Cambiar modo oscuro/claro">
        <span class="dark-mode-icon">üåô</span>
    </button>
    
    <div class="container">
        <div id="userInfo" class="user-info">
            <!-- Se llenar√° din√°micamente con auth.js -->
        </div>
        
        <!-- Bot√≥n flotante para crear cliente (solo cuando est√©s logueado) -->
        <div id="botonCrearClienteFlotante" class="boton-flotante oculto">
            <button class="btn-flotante" title="Nuevo Cliente">
                ‚ûï
            </button>
        </div>
        
        <div class="main-header">
            <div class="header-logo-container">
                <div class="header-content">
                    <h1>Maika Porcuna</h1>
                    <h2 class="subtitle-header">NUTRICI√ìN/DIET√âTICA/SUPLEMENTACI√ìN/NUTRICI√ìN DEPORTIVA</h2>
                    <h3 class="plan-title">PLAN DE ALIMENTACI√ìN PERSONALIZADO</h3>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="dietForm">
                <h2>Datos Personales</h2>
                
                <div class="form-group">
                    <label for="nombre">Nombre completo:</label>
                    <input type="text" id="nombre" name="nombre" title="Ingresa el nombre completo del cliente" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fechaRegistro">Fecha de registro:</label>
                        <input type="date" id="fechaRegistro" name="fechaRegistro" title="Fecha de registro del cliente" required>
                    </div>

                    <div class="form-group">
                        <label for="sexo">Sexo:</label>
                        <select id="sexo" name="sexo" title="Sexo del cliente" required>
                            <option value="">Selecciona...</option>
                            <option value="Mujer">Mujer</option>
                            <option value="Hombre">Hombre</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edad">Edad:</label>
                        <input type="number" id="edad" name="edad" title="Edad del cliente en a√±os" placeholder="18-100" required min="18" max="100">
                    </div>

                    <div class="form-group">
                        <label for="altura">Altura (cm):</label>
                        <input type="number" id="altura" name="altura" title="Altura en cent√≠metros" placeholder="140.0-220.0" required min="140" max="220" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="peso">Peso (kg):</label>
                        <input type="number" id="peso" name="peso" title="Peso en kilogramos" placeholder="40.000-200.000" required min="40" max="200" step="0.001">
                    </div>
                </div>

                <div class="form-group">
                    <label for="tipoPersona">Tipo de persona:</label>
                    <select id="tipoPersona" name="tipoPersona" title="Selecciona el nivel de actividad f√≠sica" required>
                        <option value="">Selecciona...</option>
                        <option value="sedentaria">Sedentaria</option>
                        <option value="activa">Activa</option>
                        <option value="muy-activa">Muy activa</option>
                    </select>
                </div>

                <h2>Macronutrientes (Auto-calculados)</h2>

                <div class="macro-info">
                    <div class="macro-item">
                        <label for="calorias">Calor√≠as diarias:</label>
                        <input type="number" id="calorias" name="calorias" title="Calor√≠as diarias calculadas autom√°ticamente" placeholder="Auto-calculado" readonly>
                    </div>
                    <div class="macro-item">
                        <label for="proteinas">Prote√≠nas (g):</label>
                        <input type="number" id="proteinas" name="proteinas" title="Gramos de prote√≠nas calculados autom√°ticamente" placeholder="Auto-calculado" readonly>
                    </div>
                    <div class="macro-item">
                        <label for="grasas">Grasas (g):</label>
                        <input type="number" id="grasas" name="grasas" title="Gramos de grasas calculados autom√°ticamente" placeholder="Auto-calculado" readonly>
                    </div>
                    <div class="macro-item">
                        <label for="carbohidratos">Carbohidratos (g):</label>
                        <input type="number" id="carbohidratos" name="carbohidratos" title="Gramos de carbohidratos calculados autom√°ticamente" placeholder="Auto-calculado" readonly>
                    </div>
                </div>

                <h2>Objetivo</h2>

                <div class="form-group">
                    <label for="objetivo">
                        Selecciona tu objetivo:
                        <span class="tooltip-icon" data-tooltip="El objetivo determina la distribuci√≥n de calor√≠as y macronutrientes. Aumentar: super√°vit cal√≥rico, Perder: d√©ficit cal√≥rico, Mantener: equilibrio energ√©tico.">‚ÑπÔ∏è</span>
                    </label>
                    <select id="objetivo" name="objetivo" title="Selecciona el objetivo de la dieta" required>
                        <option value="">Selecciona...</option>
                        <option value="aumentar">Aumentar masa muscular</option>
                        <option value="adelgazar">Perder peso</option>
                        <option value="mantener">Mantener peso</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="modoGeneracion">
                        Modo de generaci√≥n del plan:
                        <span class="tooltip-icon" data-tooltip="Autom√°tico: el sistema genera el plan completo. Manual: t√∫ introduces cada alimento y cantidad.">‚ÑπÔ∏è</span>
                    </label>
                    <select id="modoGeneracion" name="modoGeneracion" title="Selecciona el modo de generaci√≥n del plan" required>
                        <option value="automatico">Generaci√≥n Autom√°tica</option>
                        <option value="manual">Generaci√≥n Manual (Editable)</option>
                    </select>
                </div>

                <h2>Entrenamiento y Actividad F√≠sica</h2>

                <div class="form-group">
                    <label>
                        D√≠as de entrenamiento semanal:
                        <span class="tooltip-icon" data-tooltip="Selecciona los d√≠as de la semana en que entrenas. Esto ajustar√° las calor√≠as seg√∫n el d√≠a.">‚ÑπÔ∏è</span>
                    </label>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="lunes" id="entreno-lunes" checked aria-label="Lunes - d√≠a de entrenamiento" title="Marcar para incluir lunes como d√≠a de entrenamiento">
                            <span>Lunes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="martes" id="entreno-martes" checked aria-label="Martes - d√≠a de entrenamiento" title="Marcar para incluir martes como d√≠a de entrenamiento">
                            <span>Martes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="miercoles" id="entreno-miercoles" checked aria-label="Mi√©rcoles - d√≠a de entrenamiento" title="Marcar para incluir mi√©rcoles como d√≠a de entrenamiento">
                            <span>Mi√©rcoles</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="jueves" id="entreno-jueves" checked aria-label="Jueves - d√≠a de entrenamiento" title="Marcar para incluir jueves como d√≠a de entrenamiento">
                            <span>Jueves</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="viernes" id="entreno-viernes" checked aria-label="Viernes - d√≠a de entrenamiento" title="Marcar para incluir viernes como d√≠a de entrenamiento">
                            <span>Viernes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="sabado" id="entreno-sabado" checked aria-label="S√°bado - d√≠a de entrenamiento" title="Marcar para incluir s√°bado como d√≠a de entrenamiento">
                            <span>S√°bado</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diaEntreno" value="domingo" id="entreno-domingo" aria-label="Domingo - d√≠a de entrenamiento" title="Marcar para incluir domingo como d√≠a de entrenamiento">
                            <span>Domingo</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="actividadFisicaDeporte">
                        Actividad f√≠sica del deporte:
                        <span class="tooltip-icon" data-tooltip="Nivel de actividad f√≠sica relacionada con tu entrenamiento deportivo.">‚ÑπÔ∏è</span>
                    </label>
                    <select id="actividadFisicaDeporte" name="actividadFisicaDeporte" title="Selecciona tu nivel de actividad f√≠sica del deporte" required>
                        <option value="sedentario">Sedentario: trabajo de escritorio sin ejercicio</option>
                        <option value="ligera">Actividad ligera: 1-3 d√≠as de entrenamiento semanal o trabajo f√≠sico</option>
                        <option value="moderada" selected>Actividad moderada: 3-5 d√≠as de entrenamiento semanal</option>
                        <option value="intensa">Actividad intensa: 6-7 d√≠as de entrenamiento semanal</option>
                        <option value="muy-intensa">Actividad muy intensa: doble entrenamiento diario + ejercicios de gran demanda de fuerza</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="superavitEntreno">
                            Super√°vit/D√©ficit d√≠a entrenamiento (%):
                            <span class="tooltip-icon" data-tooltip="Porcentaje de super√°vit (positivo) o d√©ficit (negativo) para d√≠as de entrenamiento. Ejemplo: 5 para super√°vit del 5%, -10 para d√©ficit del 10%.">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="superavitEntreno" name="superavitEntreno" title="Super√°vit o d√©ficit para d√≠as de entrenamiento" placeholder="5" value="5" step="0.1" min="-50" max="50">
                    </div>
                    <div class="form-group">
                        <label for="superavitDescanso">
                            Super√°vit/D√©ficit d√≠a descanso (%):
                            <span class="tooltip-icon" data-tooltip="Porcentaje de super√°vit (positivo) o d√©ficit (negativo) para d√≠as de descanso. Ejemplo: 5 para super√°vit del 5%, -10 para d√©ficit del 10%.">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="superavitDescanso" name="superavitDescanso" title="Super√°vit o d√©ficit para d√≠as de descanso" placeholder="5" value="5" step="0.1" min="-50" max="50">
                    </div>
                </div>

                <div class="form-group">
                    <label for="tipoTermogenico">
                        Tipo de efecto termog√©nico:
                        <span class="tooltip-icon" data-tooltip="El efecto termog√©nico de los alimentos (TEF) var√≠a seg√∫n tu nivel de actividad. Persona sedentaria: 10%, No sedentaria: 15%, Culturista en competici√≥n: 20%.">‚ÑπÔ∏è</span>
                    </label>
                    <select id="tipoTermogenico" name="tipoTermogenico" title="Selecciona el tipo de efecto termog√©nico" required>
                        <option value="sedentaria">Persona sedentaria: 10%</option>
                        <option value="no-sedentaria" selected>Persona no sedentaria: 15%</option>
                        <option value="culturista">Culturista en estado de competici√≥n: 20%</option>
                    </select>
                </div>

                <h2>Prohibiciones y Alergias</h2>

                <div class="form-group">
                    <label>Selecciona intolerancias comunes (opcional):</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="lactosa" id="intol-lactosa" title="Marcar si tienes intolerancia a la lactosa" aria-label="Intolerancia a la lactosa">
                            <span>Lactosa</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="gluten" id="intol-gluten" title="Marcar si tienes intolerancia al gluten" aria-label="Intolerancia al gluten">
                            <span>Gluten</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="frutos-secos" id="intol-frutos-secos" title="Marcar si tienes alergia a los frutos secos" aria-label="Alergia a los frutos secos">
                            <span>Frutos Secos</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="huevo" id="intol-huevo" title="Marcar si tienes alergia al huevo" aria-label="Alergia al huevo">
                            <span>Huevo</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="pescado" id="intol-pescado" title="Marcar si tienes alergia al pescado" aria-label="Alergia al pescado">
                            <span>Pescado</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="mariscos" id="intol-mariscos" title="Marcar si tienes alergia a los mariscos" aria-label="Alergia a los mariscos">
                            <span>Mariscos</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="soja" id="intol-soja" title="Marcar si tienes alergia a la soja" aria-label="Alergia a la soja">
                            <span>Soja</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="cacahuetes" id="intol-cacahuetes" title="Marcar si tienes alergia a los cacahuetes" aria-label="Alergia a los cacahuetes">
                            <span>Cacahuetes</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="carne-roja" id="intol-carne-roja" title="Marcar si no puedes consumir carne roja" aria-label="No consumir carne roja">
                            <span>Carne Roja</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="cerdo" id="intol-cerdo" title="Marcar si no puedes consumir cerdo" aria-label="No consumir cerdo">
                            <span>Cerdo</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="azufre" id="intol-azufre" title="Marcar si tienes intolerancia a los sulfitos" aria-label="Intolerancia a los sulfitos">
                            <span>Sulfitos</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="intolerancia" value="levadura" id="intol-levadura" title="Marcar si tienes intolerancia a la levadura" aria-label="Intolerancia a la levadura">
                            <span>Levadura</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Preferencias diet√©ticas (opcional):</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="preferencia" value="vegetariano" id="pref-vegetariano" title="Marcar si sigues una dieta vegetariana" aria-label="Dieta vegetariana">
                            <span>Vegetariano</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="preferencia" value="vegano" id="pref-vegano" title="Marcar si sigues una dieta vegana" aria-label="Dieta vegana">
                            <span>Vegano</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="preferencia" value="pescetariano" id="pref-pescetariano" title="Marcar si sigues una dieta pescetariana" aria-label="Dieta pescetariana">
                            <span>Pescetariano</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="preferencia" value="bajo-carbohidratos" id="pref-bajo-carbs" title="Marcar si prefieres una dieta baja en carbohidratos" aria-label="Dieta baja en carbohidratos">
                            <span>Bajo en Carbohidratos</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="preferencia" value="cetogenica" id="pref-keto" title="Marcar si sigues una dieta cetog√©nica" aria-label="Dieta cetog√©nica">
                            <span>Cetog√©nica</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="prohibiciones">Indica otros alimentos prohibidos o alergias (opcional):</label>
                    <textarea id="prohibiciones" name="prohibiciones" rows="3" title="Lista adicional de alimentos prohibidos o alergias" placeholder="Ej: Cebolla, cilantro, champi√±ones..."></textarea>
                </div>

                <div class="form-group">
                    <label for="duracion">Duraci√≥n del plan:</label>
                    <select id="duracion" name="duracion" title="Selecciona la duraci√≥n del plan de alimentaci√≥n" required>
                        <option value="semana">1 Semana</option>
                        <option value="2semanas">2 Semanas</option>
                        <option value="3semanas">3 Semanas</option>
                        <option value="mes">1 Mes (4 Semanas)</option>
                    </select>
                </div>

                <h2>Hidrataci√≥n</h2>

                <div class="form-group">
                    <label for="hidratacion">Consumo actual de agua (litros/d√≠a):</label>
                    <input type="number" id="hidratacion" name="hidratacion" min="0" max="10" step="0.5" value="2" placeholder="2.0" title="Indica cu√°ntos litros de agua bebes al d√≠a" aria-label="Consumo actual de agua en litros por d√≠a">
                    <small class="form-help">Recomendaci√≥n general: 2-3 litros/d√≠a. Se calcular√° una recomendaci√≥n personalizada seg√∫n tu peso y actividad.</small>
                </div>

                <button type="submit" class="btn-submit" title="Generar plan de alimentaci√≥n personalizado">‚ú® Generar Plan de Alimentaci√≥n</button>
            </form>
        </div>

        <div id="resultados" class="resultados oculto">
            <div class="print-header">
                <div class="btn-container">
                    <button type="button" id="btnGuardar" class="btn-save" title="Guardar dieta en Firebase">
                        üíæ Guardar Dieta
                    </button>
                    <button type="button" id="btnEditarDieta" class="btn-edit" title="Editar la dieta antes de descargar">
                        ‚úèÔ∏è Editar Dieta
                    </button>
                    <button type="button" id="btnDescargar" class="btn-download" title="Descargar plan en formato PDF">
                        üì• Descargar Plan en PDF
                    </button>
                    <button type="button" id="btnDescargarExcel" class="btn-download" title="Descargar plan en formato Excel">
                        üìä Descargar Plan en Excel
                    </button>
                    <button type="button" id="btnCompartirWhatsApp" class="btn-whatsapp" title="Compartir por WhatsApp (solo m√≥vil)" style="display: none;">
                        üí¨ Compartir por WhatsApp
                    </button>
                    <button type="button" id="btnNuevo" class="btn-new" title="Crear una nueva dieta">
                        üîÑ Nueva Dieta
                    </button>
                </div>
            </div>

            <!-- Contenido que se exportar√° a PDF -->
            <div id="pdf-content">
                <div class="pdf-header">
                    <div class="nutricionista-contacto-header">
                        <span class="nombre-nutricionista-header" style="display: inline-block; color: white; font-size: 1.1em; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin: 0;">MAIKA PORCUNA</span>
                        <span class="contacto-item-header" style="display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 1.1em; margin: 0; color: white;">
                            <span class="contacto-icon-header">üìß</span>
                            <a href="mailto:Maikafit1977@gmail.com" style="color: inherit; text-decoration: none;">Maikafit1977@gmail.com</a>
                        </span>
                        <span class="contacto-item-header" style="display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 1.1em; margin: 0; color: white;">
                            <span class="contacto-icon-header">üìû</span>
                            <a href="tel:+34650229987" style="color: inherit; text-decoration: none;">+34 650 229 987</a>
                        </span>
                    </div>
                    <div class="separador-header" style="width: 100%; height: 2px; background: linear-gradient(to right, transparent, rgba(255,255,255,0.5), transparent); margin: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.3);"></div>
                    <h2 class="subtitle">NUTRICI√ìN/DIET√âTICA/SUPLEMENTACI√ìN/NUTRICI√ìN DEPORTIVA</h2>
                    <h3 class="plan-subtitle">PLAN DE ALIMENTACI√ìN PERSONALIZADA</h3>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="dieta" title="Ver plan de comidas semanal">DIETA</button>
                    <button class="tab" data-tab="alimentos" title="Ver lista de alimentos recomendados">ALIMENTOS</button>
                    <button class="tab" data-tab="revisiones" title="Ver revisiones y seguimiento">REVISIONES</button>
                    <button class="tab" data-tab="calendario" title="Ver calendario de comidas">CALENDARIO</button>
                    <button class="tab" data-tab="prohibiciones" title="Ver alimentos prohibidos y alergias">PROHIBICIONES</button>
                </div>

                <div id="tab-dieta" class="tab-content active">
                    <!-- Tabla de Macronutrientes -->
                    <div class="macro-table">
                        <h3>Macronutrientes</h3>
                        <table class="tabla-macros">
                            <thead>
                                <tr>
                                    <th>NUTRIENTE</th>
                                    <th>AUTOM√ÅTICO</th>
                                    <th>AJUSTE MANUAL</th>
                                    <th>SELECCIONADO</th>
                                    <th>% CALOR√çAS</th>
                                    <th>CONSUMIDO</th>
                                    <th>ESTADO</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-macros-body">
                                <!-- Se llenar√° con JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Calculadora TMB -->
                    <div id="tmb-calculator"></div>

                    <!-- Informaci√≥n del Usuario -->
                    <div class="info-usuario-table">
                        <h3>Informaci√≥n del Usuario</h3>
                        <table class="tabla-info">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Fecha registro</th>
                                    <th>Sexo</th>
                                    <th>Edad</th>
                                    <th>Peso (kg)</th>
                                    <th>Altura (cm)</th>
                                    <th>Tipo persona</th>
                                    <th>IMC</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-info-body">
                                <!-- Se llenar√° con JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Distribuci√≥n de Entrenamientos -->
                    <div id="distribucion-entrenos" class="distribucion-entrenos-section" style="margin-top: 25px;">
                        <h3>üìÖ Distribuci√≥n Semanal de Entrenamientos</h3>
                        <table class="tabla-entrenos">
                            <thead>
                                <tr>
                                    <th>D√≠a</th>
                                    <th>Actividad</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-entrenos-body">
                                <!-- Se llenar√° con JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- C√°lculos Detallados -->
                    <div id="calculos-detallados" class="calculos-detallados-section" style="margin-top: 25px;">
                        <h3>üìä C√°lculos Nutricionales Detallados</h3>
                        <table class="tabla-calculos">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-calculos-body">
                                <!-- Se llenar√° con JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Distribuci√≥n de Macronutrientes -->
                    <div id="macronutrientes-distribucion" class="macronutrientes-section" style="margin-top: 25px;">
                        <h3>ü•ó Distribuci√≥n de Macronutrientes</h3>
                        <table class="tabla-macros-distribucion">
                            <thead>
                                <tr>
                                    <th>Macronutriente</th>
                                    <th>MODO MANUAL</th>
                                    <th>G/KG CORPORAL (Entreno)</th>
                                    <th>G/KG CORPORAL (Descanso)</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-macros-distribucion-body">
                                <!-- Se llenar√° con JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Plan de Alimentaci√≥n Semanal -->
                    <div id="plan-alimentacion" class="plan-alimentacion">
                        <!-- Se llenar√° con JS -->
                    </div>

                    <!-- Nota sobre agua (solo una vez) -->
                    <div id="nota-agua" class="notas-agua-section" style="margin-top: 30px; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">üìù NOTA IMPORTANTE</h4>
                        <p style="margin: 0; color: #0c5460;">Recuerda beber al menos 2-3 litros de agua al d√≠a. Ajusta las porciones seg√∫n tu nivel de saciedad y energ√≠a.</p>
                    </div>
                </div>

                <div id="tab-alimentos" class="tab-content">
                    <h2>Lista de Alimentos Recomendados</h2>
                    <div class="alimentos-info">
                        <h3>Prote√≠nas</h3>
                        <p>Pollo, pavo, pescado, huevos, carne magra, tofu, legumbres, l√°cteos bajos en grasa.</p>
                        
                        <h3>Carbohidratos</h3>
                        <p>Arroz integral, avena, quinoa, batata, patatas, pasta integral, pan integral, frutas.</p>
                        
                        <h3>Grasas Saludables</h3>
                        <p>Aceite de oliva, aguacate, frutos secos, semillas, pescado azul, mantequilla de cacahuete.</p>
                        
                        <h3>Verduras y Hortalizas</h3>
                        <p>Br√≥coli, espinacas, lechuga, tomate, pepino, zanahoria, calabac√≠n, pimientos, esp√°rragos.</p>
                    </div>
                </div>

                <div id="tab-revisiones" class="tab-content">
                    <h2>Revisiones y Seguimiento</h2>
                    <div class="revisiones-info">
                        <h3>Recomendaciones de seguimiento</h3>
                        <ul>
                            <li>Pesarse una vez por semana, siempre a la misma hora</li>
                            <li>Tomar medidas corporales cada 2 semanas</li>
                            <li>Hacer fotos de progreso mensualmente</li>
                            <li>Revisar sensaciones de energ√≠a y saciedad diariamente</li>
                            <li>Ajustar calor√≠as seg√∫n resultados cada 3-4 semanas</li>
                        </ul>
                    </div>
                </div>

                <div id="tab-calendario" class="tab-content">
                    <h2>Calendario de Comidas</h2>
                    <div class="calendario-info">
                        <h3>Horarios recomendados</h3>
                        <table class="tabla-horarios">
                            <tr>
                                <th>Comida</th>
                                <th>Horario sugerido</th>
                            </tr>
                            <tr>
                                <td>üç≥ Desayuno</td>
                                <td>7:00 - 9:00</td>
                            </tr>
                            <tr>
                                <td>ü•§ Mediod√≠a</td>
                                <td>10:30 - 11:30</td>
                            </tr>
                            <tr>
                                <td>üçΩÔ∏è Comida</td>
                                <td>13:00 - 15:00</td>
                            </tr>
                            <tr>
                                <td>ü•ô Merienda</td>
                                <td>17:00 - 18:00</td>
                            </tr>
                            <tr>
                                <td>üåô Cena</td>
                                <td>20:00 - 22:00</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div id="tab-prohibiciones" class="tab-content">
                    <h2>Prohibiciones y Alergias</h2>
                    <div id="prohibiciones-info" class="prohibiciones-info">
                        <!-- Se llenar√° con JS -->
                    </div>
                </div>

                <div class="pdf-footer">
                    <p>¬© 2025 Maika Porcuna - Nutrici√≥n/Diet√©tica/Suplementaci√≥n Plan generado el <span id="fecha-generacion"></span></p>
                    <p style="margin: 10px 0;">Este plan es personalizado y confidencial</p>
                    <div class="pdf-footer-contacto">
                        <p class="contacto-item">
                            <span class="contacto-icon">üìû</span> 
                            <a href="tel:+34650229987" style="color: inherit; text-decoration: none;">+34 650 229 987</a>
                        </p>
                        <p class="contacto-item">
                            <span class="contacto-icon">üìß</span> 
                            <a href="mailto:Maikafit1977@gmail.com" style="color: inherit; text-decoration: none;">Maikafit1977@gmail.com</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Librer√≠as externas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Scripts en orden de dependencia -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <!-- Script para modo oscuro -->
    <script>
        // Gestor de modo oscuro
        (function() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            
            // Cargar preferencia guardada
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                body.classList.add('dark-mode');
                updateIcon();
            }
            
            // Toggle del modo oscuro
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    body.classList.toggle('dark-mode');
                    const isDark = body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDark);
                    updateIcon();
                });
            }
            
            function updateIcon() {
                const icon = darkModeToggle?.querySelector('.dark-mode-icon');
                if (icon) {
                    if (body.classList.contains('dark-mode')) {
                        icon.textContent = '‚òÄÔ∏è';
                    } else {
                        icon.textContent = 'üåô';
                    }
                }
            }
        })();
    </script>
    <script src="dietaService.js"></script>
    <script src="clienteService.js"></script>
    <script src="base-datos-alimentos.js"></script>
    <script src="alimentoService.js"></script>
    <script src="generador-dietas.js"></script>
    <!-- editor-dietas.js REMOVIDO: Sistema antiguo reemplazado por tabla-editable.js -->
    <script src="verificar-firestore.js"></script>
    <script src="cliente-manager.js"></script>
    <script src="gestor-alimentos-manager.js"></script>
    <script src="tabla-editable.js"></script>
    <script src="diagnostico-tabla-editable.js"></script>
    <script src="ui-manager.js"></script>
    <script src="script.js"></script>
    
    <!-- Service Worker Registration con Auto-actualizaci√≥n -->
    <script>
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            let refreshing = false;
            let operacionCriticaEnCurso = false; // Bandera para prevenir reload durante operaciones cr√≠ticas
            
            // Funci√≥n para marcar operaci√≥n cr√≠tica (evitar reload durante generaci√≥n de plan)
            window.marcarOperacionCritica = function(enCurso) {
                operacionCriticaEnCurso = enCurso;
                if (enCurso) {
                    console.log('üîí Operaci√≥n cr√≠tica iniciada - reload deshabilitado');
                } else {
                    console.log('üîì Operaci√≥n cr√≠tica finalizada - reload habilitado');
                }
            };
            
            // Funci√≥n para verificar si se puede recargar
            function puedeRecargar() {
                if (operacionCriticaEnCurso) {
                    console.log('‚ö†Ô∏è Reload bloqueado - operaci√≥n cr√≠tica en curso');
                    return false;
                }
                return !refreshing;
            }
            
            // Registrar Service Worker
            navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
                .then((registration) => {
                    console.log('‚úÖ Service Worker registrado exitosamente:', registration.scope);
                    
                    // Detectar cuando hay una nueva versi√≥n disponible
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ Nueva versi√≥n del Service Worker detectada');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Hay una nueva versi√≥n instalada
                                console.log('‚ú® Nueva versi√≥n disponible. Esperando momento adecuado para aplicar...');
                                
                                // NO forzar activaci√≥n inmediata si hay operaci√≥n cr√≠tica
                                if (!operacionCriticaEnCurso) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    
                                    // Recargar la p√°gina cuando el nuevo worker est√© activo
                                    newWorker.addEventListener('controllerchange', () => {
                                        if (puedeRecargar()) {
                                            refreshing = true;
                                            console.log('üîÑ Recargando para aplicar actualizaci√≥n...');
                                            window.location.reload();
                                        } else {
                                            console.log('‚è∏Ô∏è Recarga pospuesta - operaci√≥n cr√≠tica en curso');
                                        }
                                    });
                                } else {
                                    console.log('‚è∏Ô∏è Actualizaci√≥n pospuesta - operaci√≥n cr√≠tica en curso');
                                }
                            }
                        });
                    });
                    
                    // Verificar actualizaciones cada 5 minutos cuando la app est√° activa
                    // PERO solo si no hay operaci√≥n cr√≠tica
                    setInterval(() => {
                        if (!operacionCriticaEnCurso) {
                            registration.update().then(() => {
                                console.log('üîç Verificando actualizaciones...');
                            }).catch((error) => {
                                console.log('Verificaci√≥n de actualizaciones:', error.message);
                            });
                        }
                    }, 5 * 60 * 1000); // 5 minutos
                    
                    // Verificar actualizaciones al recuperar el foco de la ventana (solo si no hay operaci√≥n cr√≠tica)
                    window.addEventListener('focus', () => {
                        if (!operacionCriticaEnCurso) {
                            registration.update().catch(() => {});
                        }
                    });
                    
                    // Verificar actualizaciones al cargar la p√°gina
                    registration.update().catch(() => {});
                    
                })
                .catch((error) => {
                    console.error('‚ùå Error al registrar Service Worker:', error);
                });
            
            // Escuchar cambios del Service Worker - CON PROTECCI√ìN
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (puedeRecargar()) {
                    refreshing = true;
                    console.log('üîÑ Controller cambi√≥, recargando...');
                    window.location.reload();
                } else {
                    console.log('‚è∏Ô∏è Recarga pospuesta - operaci√≥n cr√≠tica en curso');
                }
            });
        }
        
        // La persistencia de Firebase Auth ya est√° configurada en firebase-config.js
        // La sesi√≥n se mantendr√° incluso despu√©s de actualizar la PWA
    </script>
    
    <!-- Verificaci√≥n de carga de scripts -->
    <script>
        // Verificar que todos los scripts necesarios se hayan cargado
        window.addEventListener('load', function() {
            console.log('üîç Verificando scripts cargados...');
            console.log('GestorAlimentosManager:', typeof window.GestorAlimentosManager);
            console.log('gestorAlimentosManager:', typeof window.gestorAlimentosManager);
            console.log('AlimentoService:', typeof window.alimentoService);
            console.log('baseDatosAlimentos:', typeof window.baseDatosAlimentos);
            
            // Si GestorAlimentosManager no est√° disponible, intentar cargarlo manualmente
            if (typeof window.GestorAlimentosManager === 'undefined') {
                console.error('‚ùå GestorAlimentosManager no est√° disponible despu√©s de cargar todos los scripts');
                console.log('Scripts cargados:', Array.from(document.querySelectorAll('script[src]')).map(s => s.src));
            } else {
                console.log('‚úÖ GestorAlimentosManager est√° disponible');
            }
        });
    </script>
</body>
</html>
